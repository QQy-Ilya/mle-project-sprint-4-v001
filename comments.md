# Проект. Создание рекомендательной системы

### Задача

За основу возьмите взаимодействия ~1,4 млн пользователей с 1 млн треков.

1. Используя изученные в предыдущих уроках алгоритмы, постройте пайплайн для расчёта персональных рекомендаций.
2. Разработайте сервис рекомендаций.
3. Результатом работы должен стать набор скриптов в репозитории, выполнение которых позволит рассчитать персональные рекомендации, а затем запустить соответствующий сервис и получить их.

### Данные

Данные находятся в трёх файлах.

1. Данные о треках — в файле tracks.parquet:

    *track_id* — идентификатор музыкального трека;\
    *albums* — список идентификаторов альбомов, содержащих трек;\
    *artists* — список идентификаторов исполнителей трека;\
    *genres* — список идентификаторов жанров, к которым принадлежит трек.

2. Имена артистов, названия альбомов, треков и жанров — в файле catalog_names.parquet:

    *id* — идентификатор одной из каталожных единиц (трека, альбома, исполнителя, жанра);\
    *type* — тип идентификатора;\
    *name* — имя (название) каталожной единицы.

3. Данные о том, какие пользователи прослушали тот или иной трек, — в файле interactions.parquet :

    *user_id* — идентификатор пользователя,\
    *track_id* — идентификатор музыкального трека,\
    *track_seq* — номер места трека в истории пользователя,\
    *started_at* — дата начала прослушивания трека.

### Инфраструктура и инструменты

Для выполнения проекта вам понадобятся те же самые инструменты, которые вы использовали в уроках этого спринта:

    Виртуальное окружение Python
    Jupyter Lab
    Visual Studio Code
    Персональный S3-бакет

## Этап 1. Первичная подготовка данных

В ходе этапа 1 проведен обзор данных из tracks.parquet, catalog_names.parquet, interactions.parquet

Выявлены следующие особенности:

1. В tracks, catalog_names, interactions ячеек со значением NaN

2. В catalog_names объекты с разными type могут иметь одинаковый id, следует обращать на это внимание

3. Наличие дубликатов в датасетах не очевидно:

    а) catalog_names: треки и альбомы могут как иметь, так и не иметь одинаковые названия, у исполнителей могут быть одинаковые имена, тем не менее одинаковые объекты могут иметь различные id.\
    б) tracs: треки могут иметь более одного исполнителя, относиться к нескольким жанрам и альбомам, id которых сохранены в виде списков в соответствующих колонках. В списках могут значиться id одинаковых объектов из catalog_names, тем не менее даже одинаковый жанр, исполнитель и альбом не означает, что встречен дубликат трека\
    в) interactions: дубликатов по сочетанию пользователя, трека и даты не найдено, однако некоторы треки все-таки могут быть дубликатами.
        
    Будем считать, что существует 1 000 000 уникальных треков, то есть в tracs нет дубликатов, значит, события в interactions также уникальны. Тем не менее к одному треку в tracs нередко относится список альбомов или исполнителей, ссылающийся на объекты с одинаковыми именами в catalog_names, а иногда и альбомы и исполнители разные. Очистка датасета от подобных ошибок требует более детального анализа, который будет проведен при формирования более удобных датасетов для дальнейшего обучения моделей.

4. В interactions индексация обнулялась для каждого user_id (по аналогии со столбцом 'track_seq'), индексация заменена на сквозную.
    
5. Не все id жанров, присутствующие в tracks, есть в каталоге catalog_names.

    Для удобства сразу составим таблицы tracs_by_users и genres_by_users, посчитаем количество пользователей для каждого объекта. Будем считать, что в датасете 173 уникальных жанра, из них 143 есть каталоге catalog_names, еще 30 в каталоге отсутствуют, им были даны имена вида 'other_genre_{id}'.

### Результат этапа:

1. Выполненный код в ноутбуке recommendations.ipynb


## Этап 2. Анализ данных и их подготовка

В ходе этапа 2 был проведен EDA

### Выводы
1. Количество пользователей сервиса и взаимодействия с ним росло до 10.2022, затем установилось примерно на одном уровне (около $10^6$ пользователей и $3\cdot 10^7$ взаимодействий)
2. Самый популярный трек на 12.2022 - Smells Like Teen Spirit, Nirvana (id=53404), за год его прослушали 111062 раз.
3. Самый полпулярный жанр на 12.2022 - pop (id=11), за год песни этого жанра прослушали 55578312 раз.
4. Треков, которые никто за году не прослушал в базе данных нет, каждый трек прослушали как минимум 5 раз

Также была проведена подготовка данных для дальнейшего использования

tracks:
1. id жанров, артистов и альбомов заменены на их названия, исключены повторяющиеся названия\
2. Добавлена информация о количестве просмотров и названия треков
3. Название столбца track_id заменено на item_id

    *item_id* — идентификатор музыкального трека\
    *albums* — список альбомов, к которым относится музыкальный трек\
    *artists* — список артистов, к которым относится музыкальный трек\
    *genres* — список жанров, к которым относится музыкальный трек\
    *name* — название музыкального трека\
    *num_users* — количество взаимодействий с музыкальным треком за все время\
    *num_users_norm* — нормированное количество взаимодействий с музыкальным треком за все время

Таблица сохранена в фале items.parquet 

interactions:

1. Сделана сквозная индексация, название столбца track_id заменено на item_id\
2. Добавлена информация - нормированное количество взаимодействий с музыкальным треком за все время, флаг прослушивания трека

    *user_id* — идентификатор пользователя\
    *item_id* — идентификатор музыкального трека\
    *track_seq* — номер места трека в истории пользователя,\
    *started_at* — дата начала прослушивания трека\
    *num_users_norm* — нормированное количество взаимодействий с музыкальным треком за все время\
    *listened* - флаг прослушивания трека (1) для расчета метрик и скора.

Таблица сохранена в фале events.parquet

### Результаты этапа:

1. Выполненный код в ноутбуке recommendations.ipynb.
2. Файлы items.parquet, events.parquet.


## Этап 3. Офлайн-рекомендации


### Топ популярных

В ходе выполнения этапа 3 были даны рекомендации, основывая на топ 100 самых прослушиваемых треков в период с 2022-09-01 по 2202-12-15. и оценено их качество.
Таблица с рекомендациями сохранена в файле top_popular.parquet:

    *item_id* — идентификатор музыкального трека\
    *users_top* — количество взаимодействий с треком в период с 2022-09-01 по 2202-12-15,\
    *users_top_norm* — нормированное количество взаимодействий с треком в период с 2022-09-01 по 2202-12-15,\
    *num_users_norm* — нормированное количество взаимодействий с треком за все время\
    *name* — название музыкального трека\
    *albums* — список альбомов, к которым относится музыкальный трек\
    *artists* — список артистов, к которым относится музыкальный трек\
    *genres* — список жанров, к которым относится музыкальный трек
    
Для "холодных" пользователей (есть в events_test, но нет в events_train) значение метрик получились следующие: rmse = 0.15, mae = 0.12.
Доля "холодных" пользователей без каких-либо рекомендаций составляет 47%, а среднее покрытие пользователей всего 11%. То есть больше половины (53%) "холодных" пользователей получило хоть какие-то релевантные рекомендации, при этом среднее покрытие ползователей составило всего 11% треков.

Для старых пользователей (есть в events_test и в events_train) значение метрик получились следующие:  rmse = 0.13, mae = 0.12.
Доля старых пользователей без каких-либо рекомендаций составляет 72%, а среднее покрытие увеличилось до 20%. То есть только 28% старых пользователей получила релевантные рекомендации, среднее покрытие ползователей составило 20% треков.

Если сравнивать старых и "холодных" пользователей, то доля пользователей с релевантными рекомендациями выросла на 25%, но среднее покрытие  уменьшилось на 9%, метрики rmse и mae остались примерно такими же. В целом рекомендации по топ 100 рейтинга за последние несколько месяцев примерно одинаковы для "холодных" и старых пользователей, но не являются эффективными по количеству пользователей с релевантными рекомендациями и среднему покрытию пользователей.


### Персональыне рекомендаии (ALS)

Для пользователей, которые есть в events_train и events_test (common_users), с помощью ALS-модели были даны персональные рекомендации
Метрики полученных рекомендаций:

    rmse = 0.38, mae = 0.31, ndcg@5 = 0.98\
    precision = 0.0068, recall= 0.0055

Хотя ошибки увеличились по сравнению с рекомендациями по топ 100 популярных, метрика ndcg@5 показывает, что рекомендации получены достаточно точно для пользователей, для которых получилось посчитать метрику. Также ALS-модель дает по 10 рекомендаций для всех запрошенных пользователей, что соответствуют среднему покрытию, равному единице.

Рекомендации сохранены в recomendation/personal_als.parquet

### Контентные рекомендации

На основе ранее обученной ALS-модели расчитаны похожие треки.

Результат сохранен в recomendation/similar_items.parquet


### Построение признаков

Для items посчитаны и добавлены новые признаки:

    *num_albums* - количество альбомов, которые содержат трек,
    *genre_score_mean* - средняя оценка всех жанров, к которым относится трек.

Составлена таблица с дополнительными признаками user_features:

    *listening_month* - количество месяцев, в течении которых пользователь прослушивал музыку
    *tracks_listened* - количество прослушанных треков за все время
    *tracks_per_month* - среднее количество треков, прослышанных за месяц

Всего добавлено пять новых признаков для дальнейшего ранжирования рекомендаций.


### Результаты этапа:
1. Выполненный код в ноутбуке recommendations.ipynb.
2. Файлы с рекомендациями:

    top_popular.parquet,\
    similar.parquet,\
    personal_als.parquet,\
    recommendations.parquet.